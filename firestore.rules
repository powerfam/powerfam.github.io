rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // userActivity - Rate Limiting용
    match /userActivity/{userId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == userId;
    }

    // 좋아요 컬렉션 규칙
    match /likes/{postSlug} {
      // 읽기: 누구나
      allow read: if true;
      // 쓰기: 누구나 (익명 좋아요 허용, localStorage로 중복 방지)
      allow write: if true;
    }

    // 댓글 컬렉션 규칙
    match /comments/{commentId} {

      // 읽기: 누구나
      allow read: if true;

      // 쓰기: 인증된 사용자 (익명 포함)
      allow create: if request.auth != null &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.content is string &&
        request.resource.data.content.size() > 0 &&
        request.resource.data.content.size() <= 2000 &&
        request.resource.data.postSlug is string;

      // 수정: 작성자만
      allow update: if request.auth != null &&
        resource.data.authorId == request.auth.uid;

      // 삭제: 작성자만
      allow delete: if request.auth != null &&
        resource.data.authorId == request.auth.uid;
    }
  }
}
